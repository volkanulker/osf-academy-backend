<%- include("../partials/headUpper.ejs",{title:'Alibazon - Search'}) %>
<link rel="stylesheet" href="/stylesheets/search.css" />

<%- include("../partials/headBottom.ejs") %>

<div class="container">
  <%- include("../partials/nav.ejs") %> <%- include("./searchbar.ejs") %>
  <div class="row justify-content-center">
    <div id="searchResults"></div>
    <div><p class="text-danger" id="message"></p></div>
  </div>

  <%-include("../partials/footer.ejs") %>
</div>

<%- include('../partials/bottom.ejs') %>

<script>
  const form = document.querySelector("form");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    // get values
    const searchResultsEl = document.getElementById("searchResults");
    const productName = form.productname.value;
    const messageEl = document.getElementById("message");
    messageEl.textContent = "";
    searchResultsEl.innerHTML = "";
    // check product name with regex
    let match = productName.match(/^[a-zA-Z]*/);
    let match2 = productName.match(/\s*/)
    if(match2[0] === productName){
      messageEl.textContent = "No product found by this name"
      return;
    }
    if (match[0] === productName) {
      try {
        const res = await fetch("/search", {
          method: "POST",
          body: JSON.stringify({ productName }),
          headers: { "Content-Type": "application/json" },
        });
        const payload = await res.json();
        if (payload.data.length === 0) {
          messageEl.textContent = "No product found by this name";
        } else {
          // Make simple after fixing ejs bug
          payload.data.forEach((product) => {
            let productCard = `<div class="card mb-3 mt-3" style="max-width: 540px">
        <div class="row no-gutters">
          <div class="col-md-4">
            <img
              src="/images/${product.image_groups[0].images[0].link}"
              class="card-img"
              alt="${product.image_groups[0].images[0].alt}"
            />
          </div>
          <div class="col-md-8">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">${product.name}</h5>
              <p class="card-text">
                ${product.short_description}
              </p>

              <div class="card-footer bg-transparent border-dark mt-auto">
                <div class="row">
                  <div class="col sm-6">
                    <p>Price: ${product.currency} ${product.price}</p>
                  </div>
                  <div class="col sm-6">
                    <a href="/product/${product.primary_category_id}/${product.id}" class="btn btn-primary">More Info</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>`;

            searchResultsEl.innerHTML += productCard;
          });
        }
      } catch (err) {
        messageEl.textContent = "No product found by this name";
      }
    } else{
      messageEl.textContent = "No product found by this name";
    }
  });
</script>
